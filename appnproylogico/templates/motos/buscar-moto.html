{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Buscar motos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'listado_motos' %}"><i class="bi bi-motorcycle"></i> Motos</a>
      <span class="navbar-text">Buscar</span>
    </div>
  </nav>

  <div class="container py-4">
    <form method="get" action="" class="card card-body mb-3">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Texto libre</label>
          <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Patente, marca, modelo, motor, dueño" list="dl-motos">
          <datalist id="dl-motos"></datalist>
        </div>
        <div class="col-md-4">
          <label class="form-label">Marca</label>
          <input type="text" name="marca" value="{{ marca }}" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Modelo</label>
          <input type="text" name="modelo" value="{{ modelo }}" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Color</label>
          <input type="text" name="color" value="{{ color }}" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Dueño</label>
          <input type="text" name="propietario" value="{{ propietario }}" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Estado</label>
          <select name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="activa" {% if estado == 'activa' %}selected{% endif %}>Solo activas</option>
            <option value="inactiva" {% if estado == 'inactiva' %}selected{% endif %}>Solo inactivas</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Combustible</label>
          <input type="text" name="tipo_combustible" value="{{ tipo_combustible }}" class="form-control" placeholder="GASOLINA">
        </div>
        <div class="col-md-3">
          <label class="form-label">Km mínimo</label>
          <input type="number" name="km_min" value="{{ km_min }}" class="form-control" min="0">
        </div>
        <div class="col-md-3">
          <label class="form-label">Km máximo</label>
          <input type="number" name="km_max" value="{{ km_max }}" class="form-control" min="0">
        </div>
        <div class="col-md-3">
          <label class="form-label">Año mínimo</label>
          <input type="number" name="anio_min" value="{{ anio_min }}" class="form-control" min="1980">
        </div>
        <div class="col-md-3">
          <label class="form-label">Año máximo</label>
          <input type="number" name="anio_max" value="{{ anio_max }}" class="form-control" min="1980">
        </div>
        <div class="col-md-3">
          <label class="form-label">Cilindrada mínima</label>
          <input type="number" name="cil_min" value="{{ cil_min }}" class="form-control" min="50">
        </div>
        <div class="col-md-3">
          <label class="form-label">Cilindrada máxima</label>
          <input type="number" name="cil_max" value="{{ cil_max }}" class="form-control" min="50">
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-success" type="submit"><i class="bi bi-search"></i> Buscar</button>
        <a href="{% url 'buscar_moto' %}" class="btn btn-outline-secondary">Limpiar</a>
      </div>
    </form>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 mb-0">Resultados</h2>
      <span class="text-muted">{{ page_obj.paginator.count }} motos</span>
    </div>

    <div class="list-group">
      {% for mo in page_obj.object_list %}
      <a class="list-group-item list-group-item-action" href="{% url 'detalle_moto' mo.id %}">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">{{ mo.patente }} · {{ mo.marca }} {{ mo.modelo }}</h5>
          <small class="text-muted">{{ mo.estado }}</small>
        </div>
        <p class="mb-1">Color: {{ mo.color|default:"-" }} · Dueño: {{ mo.propietario_nombre|default:"-" }} · Km: {{ mo.kilometraje_actual }}</p>
        <small class="text-muted">Motor: {{ mo.numero_motor }} · Chasis: {{ mo.numero_chasis }}</small>
      </a>
      {% empty %}
      <div class="alert alert-info">No hay resultados para los filtros seleccionados.</div>
      {% endfor %}
    </div>

    <nav class="mt-3">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const dl = document.getElementById('dl-motos');
      const inp = document.querySelector('input[name="q"]');
      let t;
      function suggestMotos(q){
        if (!dl) return;
        dl.innerHTML = '';
        fetch(`/api/motos/?search=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(items => {
            (items.results || items).slice(0, 10).forEach(it => {
              const opt = document.createElement('option');
              opt.value = `${it.patente} · ${it.marca} ${it.modelo}`;
              dl.appendChild(opt);
            });
          })
          .catch(() => {});
      }
      if (inp){
        inp.addEventListener('input', function(){
          const v = this.value.trim();
          clearTimeout(t);
          t = setTimeout(() => { if (v.length >= 2) suggestMotos(v); }, 250);
        });
      }
    })();
  </script>
</body>
</html>
