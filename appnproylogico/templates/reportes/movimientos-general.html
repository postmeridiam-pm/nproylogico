{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Movimientos (Arica → Punta Arenas)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'css/theme.css' %}">
  <link rel="stylesheet" href="{% static 'css/asignaciones.css' %}">
</head>
<body class="theme-light">
  <nav class="navbar-custom">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center w-100">
        <div class="d-flex align-items-center gap-3">
          <a class="btn-nav" href="{% url 'home' %}"><i class="bi bi-arrow-left"></i> Volver</a>
          <div class="page-title"><i class="bi bi-geo-alt"></i> Movimientos (Arica → Punta Arenas)</div>
        </div>
        
      </div>
    </div>
  </nav>
  <div class="container py-3">
    <div class="card mb-3">
      <div class="card-body d-flex gap-4 flex-wrap">
        <div><strong>Motoristas cargados:</strong> <span id="cnt-mot">0</span></div>
        <div><strong>Motos cargadas:</strong> <span id="cnt-moto">0</span></div>
        <div><strong>Farmacias cargadas:</strong> <span id="cnt-far">0</span></div>
        <div><strong>Movimientos:</strong> <span id="cnt-mov">0</span></div>
        {% if user.is_superuser or user.is_staff or user|has_group:'gerente' %}
        <div class="ms-auto">
          <button id="btn-export" class="btn btn-outline-primary"><i class="bi bi-download"></i> Descargar reporte (CSV)</button>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tbl-mov">
            <thead><tr>
              <th>Farmacia</th><th>Motorista</th><th>Tipo</th><th>Fecha</th><th>Región/Comuna</th><th>Código</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-secondary" id="prev">Anterior</button>
        <span class="text-secondary" id="page-info"></span>
        <button class="btn btn-outline-secondary" id="next">Siguiente</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      

      const pag={items:[],size:10,page:1};
      const $tbody=document.querySelector('#tbl-mov tbody');
      const $info=document.getElementById('page-info');
      function render(){
        $tbody.innerHTML='';
        const start=(pag.page-1)*pag.size;const slice=pag.items.slice(start,start+pag.size);
        slice.forEach(it=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${it.farmacia}</td><td>${it.motorista}</td><td>${it.tipo_movimiento}</td><td>${new Date(it.fecha_movimiento).toLocaleString('es-CL')}</td><td>${it.region||''} / ${it.destino||''}</td><td>${it.codigo_despacho}</td>`;
          $tbody.appendChild(tr);
        });
        const pages=Math.max(1,Math.ceil(pag.items.length/pag.size));
        $info.textContent=`Página ${pag.page} de ${pages}`;
        document.getElementById('prev').disabled=pag.page<=1;
        document.getElementById('next').disabled=pag.page>=pages;
      }

      document.getElementById('prev').onclick=function(){ if(pag.page>1){ pag.page--; render(); } };
      document.getElementById('next').onclick=function(){ const pages=Math.ceil(pag.items.length/pag.size); if(pag.page<pages){ pag.page++; render(); } };

      Promise.all([
        fetch('{% static 'data/motoristas.json' %}').then(r=>r.json()),
        fetch('{% static 'data/motos.json' %}').then(r=>r.json()),
        fetch('{% static 'data/farmacias.json' %}').then(r=>r.json()),
        fetch('{% static 'data/movimientos_general.json' %}').then(r=>r.json())
      ]).then(([mot,moto,far,mov])=>{
        document.getElementById('cnt-mot').textContent=mot.length;
        document.getElementById('cnt-moto').textContent=moto.length;
        document.getElementById('cnt-far').textContent=far.length;
        document.getElementById('cnt-mov').textContent=mov.length;
        pag.items=mov;render();
      }).catch(()=>{ pag.items=[]; render(); });

      // Exportar CSV
      const btnExp=document.getElementById('btn-export');
      if(btnExp){
        btnExp.onclick=function(){
          const heads=['Farmacia','Motorista','Tipo','Fecha','Región/Comuna','Código'];
          const rows=pag.items.map(it=>{
            const fecha=new Date(it.fecha_movimiento).toLocaleString('es-CL');
            const reg=(it.region||'');
            const com=(it.destino||'');
            return [it.farmacia,it.motorista,it.tipo_movimiento,fecha,`${reg} / ${com}`,it.codigo_despacho]
              .map(v=>`"${String(v).replace(/"/g,'\"')}"`).join(',');
          });
          const csv=[heads.join(','),...rows].join('\n');
          const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');a.href=url;a.download='movimientos_arica_punta_arenas.csv';a.click();URL.revokeObjectURL(url);
        };
      }
    })();
  </script>
</body>
</html>
